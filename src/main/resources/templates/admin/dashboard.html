<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>管理者画面</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link th:href="@{/css/navbar.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>

<div th:replace="fragments/navbar :: navbar"></div>

<nav>
    <ul class="navigation">
        <li><a th:href="@{/}">ホーム</a></li>
        <li>管理者ページ</li>
    </ul>
</nav>

<div class="contents">
    <header class="admin-header">
        <h1>管理者画面</h1>
        <nav>
            <a th:href="@{/admin/products}">商品管理一覧</a>
            <a th:href="@{/admin/orders}">注文管理一覧</a>
            <a th:href="@{/admin/users}">会員一覧</a>
        </nav>
    </header>

    <div id="paymentAlert" style="display:none;">🔔 新しい注文が入りました！</div>

    <main class="container">

        <!-- ========================
             注文サマリー
        ========================= -->
        <section class="summary-box">
            <h2>注文件数サマリー</h2>

            <ul>
                <li>今日の注文件数：<span th:text="${summary.todayOrders}"></span></li>
                <li>先月の注文件数：<span th:text="${summary.lastMonthOrders}"></span></li>
                <li>今月の注文件数：<span th:text="${summary.thisMonthOrders}"></span></li>
            </ul>
        </section>

        <!-- ========================
             注文ステータス別
        ========================= -->
        <section class="summary-box">
            <h2>ステータス別 注文件数</h2>
            <ul>
                <li>注文確定：<span th:text="${summary.confirmed}"></span></li>
                <li>発送準備中：<span th:text="${summary.preparing}"></span></li>
                <li>発送済み：<span th:text="${summary.shipped}"></span></li>
            </ul>
        </section>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/webstomp-client@1/dist/webstomp.min.js"></script>

<script>
    const alertBox = document.getElementById("paymentAlert");

    // WebSocket 接続
    const socket = new SockJS('/ws');
    const stomp = webstomp.over(socket);
    stomp.debug = () => {};

    stomp.connect({}, function () {

        //ここで「controllerが送り、Configが放送したもの」を見ようとしている
        stomp.subscribe('/topic/payment', function (msg) {

            console.log("受信:", msg.body);

            alertBox.style.display = "block";
            alertBox.textContent = "🛒 新しい注文が入りました！";

            // 3 秒後に非表示に戻す
            setTimeout(() => {
                alertBox.style.display = "none";
            }, 3000);
        });
    });
</script>

</body>
</html>