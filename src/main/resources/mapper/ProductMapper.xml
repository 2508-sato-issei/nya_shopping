<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.nya_shopping.repository.ProductRepository">

    <select id="searchProducts" resultType="com.example.nya_shopping.repository.entity.Product">
        SELECT *
        FROM products
        WHERE is_active = TRUE

        <if test="category != null and category != ''">
            AND category = #{category}
        </if>

        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>

        <if test="minPrice != null">
            AND price &gt;= #{minPrice}
        </if>

        <if test="maxPrice != null">
            AND price &lt;= #{maxPrice}
        </if>

        <if test="stock != null">
            AND stock &gt;= #{stock}
        </if>

        <choose>
            <when test="sort == 'new'">
                ORDER BY created_at DESC
            </when>
            <when test="sort == 'low'">
                ORDER BY price ASC
            </when>
            <when test="sort == 'high'">
                ORDER BY price DESC
            </when>
            <otherwise>
                ORDER BY updated_at DESC
            </otherwise>
        </choose>

        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countProducts" resultType="int">
        SELECT COUNT(*)
        FROM products
        WHERE is_active = TRUE

        <if test="category != null and category != ''">
            AND category = #{category}
        </if>

        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>

        <if test="minPrice != null">
            AND price &gt;= #{minPrice}
        </if>

        <if test="maxPrice != null">
            AND price &lt;= #{maxPrice}
        </if>

        <if test="stock != null">
            AND stock &gt;= #{stock}
        </if>
    </select>

</mapper>