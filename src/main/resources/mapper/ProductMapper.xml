<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.nya_shopping.repository.ProductRepository">

    <select id="searchProducts" resultType="com.example.nya_shopping.repository.entity.Product">
        SELECT *
        FROM products
        WHERE is_active = TRUE

        <if test="category != null and category != ''">
            AND category = #{category}
        </if>

        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>

        <if test="minPrice != null">
            AND price &gt;= #{minPrice}
        </if>

        <if test="maxPrice != null">
            AND price &lt;= #{maxPrice}
        </if>

        <if test="stock != null">
            AND stock &gt;= #{stock}
        </if>

        <choose>
            <when test="sort == 'new'">
                ORDER BY created_at DESC
            </when>
            <when test="sort == 'low'">
                ORDER BY price ASC
            </when>
            <when test="sort == 'high'">
                ORDER BY price DESC
            </when>
            <otherwise>
                ORDER BY updated_at DESC
            </otherwise>
        </choose>

        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countProducts" resultType="int">
        SELECT COUNT(*)
        FROM products
        WHERE is_active = TRUE

        <if test="category != null and category != ''">
            AND category = #{category}
        </if>

        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>

        <if test="minPrice != null">
            AND price &gt;= #{minPrice}
        </if>

        <if test="maxPrice != null">
            AND price &lt;= #{maxPrice}
        </if>

        <if test="stock != null">
            AND stock &gt;= #{stock}
        </if>
    </select>

    <select id="findByIdIsActive" parameterType="int" resultType="com.example.nya_shopping.repository.entity.Product">
        SELECT
        id,
        name,
        price,
        category,
        stock,
        image_url,
        description,
        is_active,
        created_at,
        updated_at
        FROM products
        WHERE id = #{id}
        AND is_active = 1
    </select>

    <!-- 商品管理一覧表示 -->
    <select id="search" resultType="com.example.nya_shopping.repository.entity.Product">

        SELECT
        id,
        name,
        price,
        stock,
        category,
        image_url,
        is_active,
        created_at
        FROM products
        WHERE 1 = 1

        <!-- 商品名（部分一致） -->
        <if test="condition.name != null and condition.name != ''">
            AND name LIKE CONCAT('%', #{condition.name}, '%')
        </if>

        <!-- 価格下限 -->
        <if test="condition.priceMin != null">
            AND price &gt;= #{condition.priceMin}
        </if>

        <!-- 価格上限 -->
        <if test="condition.priceMax != null">
            AND price &lt;= #{condition.priceMax}
        </if>

        <!-- カテゴリ -->
        <if test="condition.category != null and condition.category != ''">
            AND category = #{condition.category}
        </if>

        <!-- 在庫ありのみ -->
        <if test="condition.stockOnly != null and condition.stockOnly == true">
            AND stock &gt; 0
        </if>

        <!-- 公開 / 非公開 -->
        <if test="condition.isActive != null">
            AND is_active = #{condition.isActive}
        </if>

        <!-- 登録日時（開始） -->
        <if test="condition.dateFrom != null and condition.dateFrom != ''">
            AND created_at &gt;= #{condition.dateFrom}
        </if>

        <!-- 登録日時（終了） -->
        <if test="condition.dateTo != null and condition.dateTo != ''">
            AND created_at &lt;= #{condition.dateTo}
        </if>

        <!-- ======== ソート解決 ======== -->
        <!-- ソートキーが正しく指定されている場合のみ ORDER BY を適用 -->
        <choose>

            <!-- sortKey: id, name, price, category, stock, created_at -->
            <when test="condition.sortKey != null
                        and condition.sortKey != ''
                        and (
                            condition.sortKey == 'id' or
                            condition.sortKey == 'name' or
                            condition.sortKey == 'price' or
                            condition.sortKey == 'category' or
                            condition.sortKey == 'stock' or
                            condition.sortKey == 'created_at'
                        )">

                ORDER BY ${condition.sortKey}
                <choose>
                    <when test="condition.sortOrder == 'asc'">ASC</when>
                    <otherwise>DESC</otherwise>
                </choose>

            </when>

            <!-- sortKey が未指定 → デフォルトソート -->
            <otherwise>
                ORDER BY id DESC
            </otherwise>
        </choose>

    </select>

    <!-- 商品登録処理 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO products (name, price, category, stock, image_url, description, is_active)
        VALUES (#{name}, #{price}, #{category}, #{stock}, #{imageUrl}, #{description}, #{isActive})
    </insert>

    <!-- 商品一括登録処理 -->
    <insert id="insertProducts" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO products
        (slip_id, billing_date, reason, transportation, round_trip, amount, subtotal, remark, original_file_name ,stored_file_name, created_date, updated_date)
        VALUES
        <foreach collection="list" item="d" separator=",">
            (#{d.slipId}, #{d.billingDate}, #{d.reason}, #{d.transportation}, #{d.roundTrip}, #{d.amount}, #{d.subtotal}, #{d.remark}, #{d.originalFileName}, #{d.storedFileName}, NOW(), NOW())
        </foreach>
    </insert>

    <!-- 商品編集画面表示 -->
    <select id="FindById" resultType="com.example.nya_shopping.repository.entity.Product">
        SELECT *
        FROM products
        WHERE id = #{id}
    </select>

    <!-- 商品編集処理 -->
    <update id="update">
        UPDATE products
        <set>
            <if test="name != null"> name = #{name}, </if>
            <if test="email != null"> email = #{email}, </if>
            <if test="phone != null"> phone = #{phone}, </if>
            <if test="address != null"> address = #{address}, </if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>