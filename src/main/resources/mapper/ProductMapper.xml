<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.nya_shopping.repository.ProductRepository">

    <select id="searchProducts" resultType="com.example.nya_shopping.repository.entity.Product">
        SELECT *
        FROM products
        WHERE is_active = TRUE

        <if test="category != null and category != ''">
            AND category = #{category}
        </if>

        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>

        <if test="minPrice != null">
            AND price &gt;= #{minPrice}
        </if>

        <if test="maxPrice != null">
            AND price &lt;= #{maxPrice}
        </if>

        <if test="stock != null">
            AND stock &gt;= #{stock}
        </if>

        <choose>
            <when test="sort == 'new'">
                ORDER BY created_at DESC
            </when>
            <when test="sort == 'low'">
                ORDER BY price ASC
            </when>
            <when test="sort == 'high'">
                ORDER BY price DESC
            </when>
            <otherwise>
                ORDER BY updated_at DESC
            </otherwise>
        </choose>

        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countProducts" resultType="int">
        SELECT COUNT(*)
        FROM products
        WHERE is_active = TRUE

        <if test="category != null and category != ''">
            AND category = #{category}
        </if>

        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>

        <if test="minPrice != null">
            AND price &gt;= #{minPrice}
        </if>

        <if test="maxPrice != null">
            AND price &lt;= #{maxPrice}
        </if>

        <if test="stock != null">
            AND stock &gt;= #{stock}
        </if>
    </select>

    <select id="findById" parameterType="int" resultType="com.example.nya_shopping.repository.entity.Product">
        SELECT
        id,
        name,
        price,
        category,
        stock,
        image_url,
        description,
        is_active,
        created_at,
        updated_at
        FROM products
        WHERE id = #{id}
        AND is_active = 1
    </select>

    <!-- 商品登録処理 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO products (name, price, category, stock, image_url, description, is_active)
        VALUES (#{name}, #{price}, #{category}, #{stock}, #{imageUrl}, #{description}, #{isActive})
    </insert>

    <!-- 商品一括登録処理 -->
    <insert id="insertProducts" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO products
        (slip_id, billing_date, reason, transportation, round_trip, amount, subtotal, remark, original_file_name ,stored_file_name, created_date, updated_date)
        VALUES
        <foreach collection="list" item="d" separator=",">
            (#{d.slipId}, #{d.billingDate}, #{d.reason}, #{d.transportation}, #{d.roundTrip}, #{d.amount}, #{d.subtotal}, #{d.remark}, #{d.originalFileName}, #{d.storedFileName}, NOW(), NOW())
        </foreach>
    </insert>

    <!-- 商品編集画面表示 -->
    <select id="editFindById" resultType="com.example.nya_shopping.repository.entity.Product">
        SELECT *
        FROM products
        WHERE id = #{id}
    </select>

    <!-- 商品編集処理 -->
    <update id="update">
        UPDATE products
        <set>
            <if test="name != null"> name = #{name}, </if>
            <if test="email != null"> email = #{email}, </if>
            <if test="phone != null"> phone = #{phone}, </if>
            <if test="address != null"> address = #{address}, </if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>